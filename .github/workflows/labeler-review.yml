# SPDX-FileCopyrightText: 2026 Sector-Vestige contributors
# SPDX-FileCopyrightText: 2024 Myra <vasilis@pikachu.systems>
# SPDX-FileCopyrightText: 2024 Saphire Lattice <lattice@saphi.re>
# SPDX-FileCopyrightText: 2024 Vasilis <vasilis@pikachu.systems>
# SPDX-FileCopyrightText: 2025 ReboundQ3 <ReboundQ3@gmail.com>
# SPDX-FileCopyrightText: 2026 ReboundQ3 <22770594+ReboundQ3@users.noreply.github.com>
#
# SPDX-License-Identifier: MIT

name: "Labels: Approved"
on:
  pull_request_review:
    types: [submitted]
jobs:
  add_label:
    # Change the repository name after you've made sure the team name is correct for your fork!
    if: ${{ (github.repository == 'Sector-Vestige/Sector-Vestige') && (github.event.review.state == 'APPROVED') }}
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
    - name: Generate GitHub App Token
      id: generate-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.APP_ID }}
        private-key: ${{ secrets.APP_PRIVATE_KEY }}

    - uses: tspascoal/get-user-teams-membership@v3
      id: checkUserMember
      with:
        username: ${{ github.actor }}
        team: "Maintainer team"
        GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}

    - name: Manage labels
      if: ${{ steps.checkUserMember.outputs.isTeamMember == 'true' }}
      uses: actions/github-script@v7
      with:
        github-token: ${{ steps.generate-token.outputs.token }}
        script: |
          const issue_number = context.issue.number;
          const owner = context.repo.owner;
          const repo = context.repo.repo;

          // Add "S: Approved" label
          await github.rest.issues.addLabels({
            owner,
            repo,
            issue_number,
            labels: ['S: Approved']
          });

          // Remove other status labels
          const labelsToRemove = ['S: Needs Review', 'S: Awaiting Changes'];
          for (const label of labelsToRemove) {
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number,
                name: label
              });
            } catch (error) {
              // Ignore errors if label doesn't exist
              if (error.status !== 404) throw error;
            }
          }
